Log 0 背景
 由于近几年使用了不同平台的手机，相册多次迁移导致相同图片存了多份，手动图片去重工作量繁重，又由于Vue3发布已久，一直没有机会使用Vue3来编写前端项目，于是我开始尝试自己开发一套用于相册图片（包括视频）去重的工具，并期望以此巩固我对Nodejs的知识理解与对Vue3的上手练习，同时以测试和体验Nodejs的更多特性和可能性。于是，这个项目诞生了，以下为Nodejs端的介绍，Vue3前端项目请移步另一工程。


Log 1 前期性能调优感悟

一、最开始，我尝试了Jimp，这是一个优秀的纯JS图片处理库，但是在海量数据面前，性能问题被无限放大（我相信Jimp能在纯浏览器端得到更高价值体现）。

二、其后，我尝试了GM和ImageMagick，这是两款知名的跨平台图片处理库，但是在Windows上GM没有提供单个的可执行文件，ImageMagick的调用也太麻烦，于是我开始寻找其他解决方案。

三、一段时间后，我发现使用谷歌的WebpC（webp-converter）库将图片初始化为Webp格式，然后再反转换为Jpeg格式，性能特别不错，且成倍提升性能的同时可以大大减少图片的体积，于是我开始尝试使用Webp格式。

四、最后，我偶然发现了Sharp，这是一个基于libvips的图片处理库，它的性能更加优秀，于是我开始使用Sharp来处理图片。根据Sharp的官方测试，其性能是Jimp的35倍左右，且支持Webp，这使得我可以继续使用步骤三的处理流程。

五、除了常规的图片格式处理，iOS的Heic格式和数码相机的Raw格式的照片也需要兼容处理，庆幸的是我找到的处理库性能还在可接受范围内，它们分别是：Heic-decode、Heic-convert和Extractd（基于ExifTool）。

六、当然，Exif的处理也是一个重要的环节，我尝试了多种方案后决定使用Exifr，它的原理和我最初的想法一致，仅读取文件的头部Chunk信息，而不是读取整个文件。当然，它提供了更加完善的处理。

七、在整个调优过程中的某一天我突然感悟，你或许可以忽视一滴水，但是你无法忽视一片海，任何微小的性能和内存损耗都会在海量数据面前显得无比可怕。

八、除了以上CPU运算方面的优化，IO优化也是性能调优的一个重要点，最初数据归类和缓存我粗暴的使用纯文件处理，后期发现还是得用上轻量级的应用数据库，Sqlite3是一个优秀的本地数据库，Sequelize更让数据操作变得简单，以至于你在该C端软件的开发过程中可以完全抛弃对数据管理和维护的顾虑。

八、展望与深入
  用Nodejs处理CPU密集型的任务固然是具有挑战性的，尽管你尽可能的使用多进程和内存共享，但这也几乎收效甚微。当前选择引入和依赖第三方语言成熟的库的方案仅是Nodejs性能调优的一种解。如果你想要更加纯粹的Nodejs单一性和更深入Nodejs底层的学习，可以尝试从以下几个方面继续研究和完善本项目，包括但不限于
  8.1 使用Rust/C++为Nodejs编写WASM模块（WebAssembly）
  8.2 使用Rust/C++为Nodejs编写N-API模块（.node模块）
  8.3 使用Rust/Go为Nodejs编写CPU密集型任务处理功能，通过命令行调用和通信
  8.4 尝试使用GPU进行运算和图处理
  8.5 尝试将Worker模块改为多进程下的多线程模型，主Hoster 对 多进程 对 多线程, 1:N:N

九、短期内的目标
  9.1 ImageTools类的初始化（init方法）的插件机制，将非常规格式的图片预处理任务独立为插件，定义标准输出（预期为一张Webp和Jpeg图像）。
  9.2 VideoTools类的基础方法，实现对视频文件的基础解析和处理。
  9.3 图片主色调提取的方法优化，尝试复用内存中的Buffer数据或缓存的图片数据，减少CPU计算量和内存占用。
  9.4 pHash算法的优化，尝试移植为内部模块，传入缓存的Buffer或流式读取图片，提高IO性能。
  9.5 相似颜色的对比方法，传入一个颜色，从常量颜色表中返回与其相似的颜色，用以后期同色调图片筛选。


  Zcy 于 2023年4月8日 02点49分